name: Build Ladybird (Arch Linux)

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]
  schedule:
    - cron: '0 */48 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    container:
      image: archlinux:latest

    steps:
      # --- BASE SYSTEM ---
      - name: Initialize Arch Linux
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed \
            base-devel \
            git \
            sudo \
            autoconf \
            autoconf-archive \
            automake \
            ccache \
            cmake \
            curl \
            libgl \
            nasm \
            ninja \
            qt6-base \
            qt6-tools \
            qt6-wayland \
            qt6-multimedia \
            libpulse \
            ttf-liberation \
            tar \
            unzip \
            zip \
            clang \
            llvm \
            lld
            
      # --- CREATE NON-ROOT BUILDER USER ---
      - name: Create builder user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder "$GITHUB_WORKSPACE"

      # --- TRUST WORKSPACE FOR GIT ---
      - name: Trust workspace for Git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # --- CHECKOUT REPOSITORY ---
      - name: Clone repository
        run: |
          git clone https://github.com/unofficial-ladybird-builds/ladybird-bin .
          git fetch --all --tags
          git checkout "${{ github.ref_name }}"
          chown -R builder:builder .

      # --- SYNC WITH UPSTREAM (PRESERVE .github) ---
      - name: Sync with upstream (preserve .github)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git remote add upstream https://github.com/LadybirdBrowser/ladybird.git || true
          git fetch upstream master

          git checkout upstream/master -- .
          git restore --source=HEAD --staged --worktree .github
          git restore --staged --worktree -- README.md

          git add -A
          git commit -m "Sync with upstream (before build)" || echo "No changes to commit"
          chown -R builder:builder .

      # --- TOOLCHAIN ---
      - name: Set Clang toolchain
        run: |
          echo "CC=clang" >> /etc/environment
          echo "CXX=clang++" >> /etc/environment

      - name: Show tool versions
        run: |
          clang --version
          cmake --version
          ninja --version
          pacman -Qi icu | sed -n '1,5p'

      # --- VCPKG DEPENDENCIES ---
      - name: Bootstrap vcpkg and install dependencies
        run: |
          sudo -u builder git clone https://github.com/microsoft/vcpkg.git Build/vcpkg
          cd Build/vcpkg
          sudo -u builder ./bootstrap-vcpkg.sh
          export VCPKG_DISABLE_METRICS=1
          sudo -u builder ./vcpkg install
          cd ../..

      # --- BUILD (NON-ROOT, REQUIRED) ---
      - name: Build Ladybird
        run: |
          chmod +x ./Meta/ladybird.py
          sudo -u builder env BUILD_PRESET=Release \
          cmake -B build -S . \
           -DCMAKE_TOOLCHAIN_FILE=Build/vcpkg/scripts/buildsystems/vcpkg.cmake \
           -DCMAKE_FIND_PACKAGE_PREFER_CONFIG=ON          sudo -u builder ./Meta/ladybird.py build

      - name: Verify ICU version
        run: |
         grep -R "ICU_VERSION" build/CMakeCache.txt || true


      # --- RESOURCES ---
      - name: Ensure resources exist
        run: |
          sudo -u builder mkdir -p Resources
          if [ ! -f Resources/home-page.html ]; then
            echo "<html><body><h1>Hello, Ladybird</h1></body></html>" | sudo -u builder tee Resources/home-page.html
          fi

          sudo -u builder mkdir -p Build/release/bin/resources
          sudo -u builder cp Resources/* Build/release/bin/resources/

      # --- COLLECT LIBS ---
      - name: Copy shared libraries
        run: |
          sudo -u builder bash -c 'find Build/release -name "*.so*" -exec cp {} Build/release/bin/ \; || true'

      # --- PACKAGE ---
      - name: Package build
        run: |
          sudo -u builder zip -r ladybird-arch-linux.zip Build

      # --- ARTIFACT ---
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-arch-linux
          path: ladybird-arch-linux.zip

      # --- RELEASE (TAGS ONLY) ---
      - name: Upload to GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ladybird-arch-linux.zip
