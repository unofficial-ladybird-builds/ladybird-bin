name: Build Ladybird (Arch Linux)

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]
  schedule:
    - cron: '0 */48 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    container:
      image: archlinux:latest

    steps:
      # --- BASE SYSTEM ---
      - name: Initialize Arch Linux
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed \
            base-devel \
            git \
            autoconf \
            autoconf-archive \
            automake \
            ccache \
            cmake \
            curl \
            libgl \
            nasm \
            ninja \
            qt6-base \
            qt6-tools \
            qt6-wayland \
            qt6-multimedia \
            libpulse \
            ttf-liberation \
            tar \
            unzip \
            zip \
            clang \
            llvm \
            lld \
            icu

      # --- CHECKOUT ---
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master

      # --- SYNC WITH UPSTREAM (PRESERVE .github) ---
      - name: Sync with upstream (preserve .github)
        run: |
                cd "$GITHUB_WORKSPACE"
            
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
            
                git remote add upstream https://github.com/LadybirdBrowser/ladybird.git || true
                git fetch upstream master
            
                git checkout upstream/master -- .
                git restore --source=HEAD --staged --worktree .github
                git restore --staged --worktree -- README.md

                git add -A
                git commit -m "Sync with upstream (before build)" || echo "No changes to commit"
      # --- TOOLCHAIN ---
      - name: Set Clang toolchain
        run: |
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV

      - name: Show tool versions
        run: |
          clang --version
          cmake --version
          ninja --version
          pacman -Qi icu | sed -n '1,5p'

      # --- CONFIGURE ---
      - name: Configure Ladybird
        run: |
          cmake -B build -S . \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release

      # --- BUILD ---
      - name: Build Ladybird
        run: |
          chmod +x ./Meta/ladybird.py
          export BUILD_PRESET=Release
          ./Meta/ladybird.py build

      # --- RESOURCES ---
      - name: Ensure resources exist
        run: |
          mkdir -p Resources
          if [ ! -f Resources/home-page.html ]; then
            echo "<html><body><h1>Hello, Ladybird</h1></body></html>" > Resources/home-page.html
          fi
          mkdir -p Build/release/bin/resources
          cp Resources/* Build/release/bin/resources/

      # --- COLLECT LIBS ---
      - name: Copy shared libraries
        run: |
          find Build/release -name "*.so*" -exec cp {} Build/release/bin/ \;

      # --- ARTIFACT ---
      - name: Package build
        run: |
          zip -r ladybird-arch-linux.zip Build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-arch-linux
          path: ladybird-arch-linux.zip

      - name: Upload to GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ladybird-arch-linux.zip
