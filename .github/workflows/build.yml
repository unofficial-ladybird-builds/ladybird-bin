name: Build Ladybird (AUR PKGBUILD)

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  schedule:
    - cron: '0 */48 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    container:
      image: archlinux:latest

    steps:
      # ----------------------------
      # BASE SYSTEM
      # ----------------------------
      - name: Initialize Arch Linux
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed \
            base-devel \
            git \
            sudo \
            ninja \
            cmake \
            curl \
            qt6-base \
            qt6-tools \
            qt6-wayland \
            qt6-multimedia \
            libgl \
            ffmpeg \
            ttf-liberation \
            nasm \
            unzip \
            zip

      # ----------------------------
      # BUILDER USER
      # ----------------------------
      - name: Create builder user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      # ----------------------------
      # FIX WORKSPACE PERMISSIONS
      # ----------------------------
      - name: Fix workspace ownership
        run: |
          chown -R builder:builder "$GITHUB_WORKSPACE"

      # ----------------------------
      # FETCH AUR PKGBUILD
      # ----------------------------
      - name: Clone Ladybird AUR repo
        run: |
          sudo -u builder git clone https://aur.archlinux.org/ladybird.git

      # ----------------------------
      # BUILD PACKAGE
      # ----------------------------
      - name: Build Ladybird from AUR
        run: |
          cd ladybird
          sudo -u builder env \
            MAKEFLAGS="-j$(nproc)" \
            makepkg -s --noconfirm

      # ----------------------------
      # COLLECT BUILD OUTPUTS
      # ----------------------------
      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          cp ladybird/*.pkg.tar.zst artifacts/
          cp -r ladybird/src artifacts/src || true
          cp -r ladybird/pkg artifacts/pkg || true

      # ----------------------------
      # UPLOAD ARTIFACTS
      # ----------------------------
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-aur-build
          path: artifacts/

      # ----------------------------
      # RELEASE (TAGS ONLY)
      # ----------------------------
      - name: Upload to GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
