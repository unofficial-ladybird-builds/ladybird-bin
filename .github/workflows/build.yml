name: Build Ladybird (AUR PKGBUILD)

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  schedule:
    - cron: '0 */48 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    container:
      image: archlinux:latest

    steps:
      # ----------------------------
      # BASE SYSTEM
      # ----------------------------
      - name: Initialize Arch Linux
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed \
            base-devel \
            git \
            sudo \
            ninja \
            cmake \
            curl \
            qt6-base \
            qt6-tools \
            qt6-wayland \
            qt6-multimedia \
            libgl \
            ffmpeg \
            ttf-liberation \
            nasm \
            unzip \
            zip \
            patchelf

      # ----------------------------
      # BUILDER USER
      # ----------------------------
      - name: Create builder user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      # ----------------------------
      # FIX WORKSPACE PERMISSIONS
      # ----------------------------
      - name: Fix workspace ownership
        run: |
          chown -R builder:builder "$GITHUB_WORKSPACE"

      # ----------------------------
      # FETCH AUR PKGBUILD
      # ----------------------------
      - name: Clone Ladybird AUR repo
        run: |
          sudo -u builder git clone https://aur.archlinux.org/ladybird.git

      # ----------------------------
      # BUILD PACKAGE
      # ----------------------------
      - name: Build Ladybird from AUR
        run: |
          cd ladybird
          sudo -u builder env MAKEFLAGS="-j$(nproc)" makepkg -s --noconfirm

      # ----------------------------
      # BUNDLE Qt6 WITH BINARY
      # ----------------------------
      - name: Bundle Qt6 for portable binary
        run: |
          cd ladybird/pkg/usr/bin
          mkdir -p lib
          # Copy all Qt6 shared libs
          cp /usr/lib/libQt6*.so* lib/
          # Also copy Qt6 plugins if needed
          mkdir -p platforms
          cp -r /usr/lib/qt/plugins/platforms/* platforms/ || true
          # Optional: copy multimedia plugins
          mkdir -p audio
          cp -r /usr/lib/qt/plugins/audio/* audio/ || true
          # Make the binary find bundled libs
          patchelf --set-rpath '$ORIGIN/lib' Ladybird

      # ----------------------------
      # CREATE ZIP ARTIFACT
      # ----------------------------
      - name: Package Ladybird portable zip
        run: |
          cd ladybird/pkg/usr/bin
          zip -r "$GITHUB_WORKSPACE/ladybird-arch-linux.zip" ./*

      # ----------------------------
      # UPLOAD ARTIFACT
      # ----------------------------
      - name: Upload portable artifact
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-arch-linux
          path: ladybird-arch-linux.zip

      # ----------------------------
      # RELEASE (TAGS ONLY)
      # ----------------------------
      - name: Upload to GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ladybird-arch-linux.zip
